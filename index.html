<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom Birthday Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Balsamiq+Sans:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Balsamiq Sans', cursive;
            background: linear-gradient(135deg, #d4edda 0%, #f4f7d2 100%);
        }
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: transparent;
            border-radius: 50%;
            pointer-events: none;
            animation: confetti-fall 2s forwards;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .confetti.show {
            opacity: 1;
        }

        @keyframes confetti-fall {
            0% { transform: translateY(0) rotate(0); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen text-gray-800 p-4 relative overflow-hidden">

    <!-- Modal for custom messages -->
    <div id="custom-modal" class="modal">
        <div class="modal-content">
            <p id="modal-text" class="text-xl mb-4"></p>
            <button id="modal-close-button" class="bg-emerald-600 text-white font-bold py-2 px-4 rounded-full hover:bg-emerald-700 transition-colors">OK</button>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="text-center">
        <div id="birthday-message" class="text-6xl md:text-8xl font-bold transition-all duration-500 transform scale-0 ease-out">
            <!-- Message will be dynamically inserted here -->
        </div>
        
        <!-- Dashboard UI -->
        <div class="mt-8 bg-white/50 backdrop-blur-sm p-6 md:p-10 rounded-3xl shadow-2xl max-w-lg w-full transition-all duration-500 ease-in-out">
            <h2 class="text-xl md:text-2xl font-bold mb-4">Birthday Reminders</h2>
            <div class="text-sm font-semibold mb-2 text-gray-700">Today's Date: <span id="today-date"></span></div>
            <div id="dashboard-message" class="text-lg md:text-xl text-gray-700 font-semibold mb-4">
                Loading birthdays...
            </div>
            
            <!-- Upcoming Birthdays -->
            <div id="upcoming-birthdays-container" class="mt-6 hidden">
                <button id="toggle-upcoming-button" class="text-sm font-semibold text-emerald-600 hover:text-emerald-800 transition-colors focus:outline-none">
                    Show Upcoming Birthdays
                </button>
                <div id="upcoming-list-wrapper" class="mt-4 p-4 bg-gray-100 rounded-lg shadow-inner hidden">
                    <h3 class="text-lg font-bold mb-2 text-gray-700">Upcoming Birthdays</h3>
                    <ul id="upcoming-list" class="text-left text-sm space-y-2 text-gray-600">
                        <!-- Upcoming birthdays will be inserted here -->
                    </ul>
                </div>
            </div>

            <!-- Upload New Data -->
            <div id="upload-section" class="mt-6 flex flex-col items-center">
                <p class="mb-2 text-gray-600 text-sm">Upload a new CSV or XLSX file to update the birthdays:</p>
                <input type="file" id="data-upload" accept=".csv, .xlsx" class="mb-4 text-sm md:text-base border border-gray-300 rounded-lg p-2 bg-gray-50 hover:bg-gray-100 transition-colors cursor-pointer">
                <a id="download-template" href="#" class="text-sm text-emerald-600 hover:text-emerald-800 underline transition-colors">Download Template CSV</a>
            </div>
            
            <button id="retrieve-upload-button" class="hidden mt-6 bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-full hover:bg-gray-400 transition-colors">Retrieve Upload</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Modal functions
        const modalEl = document.getElementById('custom-modal');
        const modalTextEl = document.getElementById('modal-text');
        const modalCloseButton = document.getElementById('modal-close-button');

        function showMessage(message) {
            modalTextEl.textContent = message;
            modalEl.style.display = 'flex';
        }

        modalCloseButton.addEventListener('click', () => {
            modalEl.style.display = 'none';
        });

        document.addEventListener('DOMContentLoaded', async () => {
            const birthdayMessageEl = document.getElementById('birthday-message');
            const dashboardMessageEl = document.getElementById('dashboard-message');
            const todayDateEl = document.getElementById('today-date');
            const dataUploadEl = document.getElementById('data-upload');
            const downloadTemplateEl = document.getElementById('download-template');
            const uploadSectionEl = document.getElementById('upload-section');
            const retrieveUploadButton = document.getElementById('retrieve-upload-button');
            const upcomingBirthdaysContainer = document.getElementById('upcoming-birthdays-container');
            const toggleUpcomingButton = document.getElementById('toggle-upcoming-button');
            const upcomingListWrapper = document.getElementById('upcoming-list-wrapper');
            const upcomingListEl = document.getElementById('upcoming-list');
            
            // Sample CSV data matching the new format
            const defaultCSV = `First name,Last name,What is the month of your Birthday?,What day of the month is your birthday?
Aaron,Oun,3,19
Adi,Sous,11,21
Alex,Aguiar,4,7
Allegh,Huoth,4,16
Amalia,Awah,2,3
Lucas,Skywalker,9,14`;

            let allBirthdays = [];

            // Function to parse CSV data based on the new format
            function parseCSV(csvText) {
                const lines = csvText.trim().split('\n');
                const result = [];
                if (lines.length < 2) return result;

                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                const firstNameIndex = headers.indexOf('first name');
                const lastNameIndex = headers.indexOf('last name');
                const monthIndex = headers.indexOf('what is the month of your birthday?');
                const dayIndex = headers.indexOf('what day of the month is your birthday?');

                if (firstNameIndex === -1 || lastNameIndex === -1 || monthIndex === -1 || dayIndex === -1) {
                    return [];
                }

                for (let i = 1; i < lines.length; i++) {
                    const parts = lines[i].split(',');
                    if (parts.length === headers.length) {
                        const firstName = parts[firstNameIndex]?.trim() || '';
                        const lastName = parts[lastNameIndex]?.trim() || '';
                        const month = parts[monthIndex]?.trim().padStart(2, '0') || '';
                        const day = parts[dayIndex]?.trim().padStart(2, '0') || '';
                        
                        if (month && day) {
                            const name = `${firstName} ${lastName}`;
                            const birthday = `${month}/${day}`;
                            result.push({ name, birthday });
                        }
                    }
                }
                return result;
            }
            
            // Function to parse XLSX data
            function parseXLSX(data) {
                const workbook = XLSX.read(data, { type: 'binary' });
                const sheetName = workbook.SheetNames[0];
                const sheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                if (jsonData.length < 2) return [];

                const headers = jsonData[0].map(h => (h ?? '').toString().trim().toLowerCase());
                const firstNameIndex = headers.indexOf('first name');
                const lastNameIndex = headers.indexOf('last name');
                const monthIndex = headers.indexOf('what is the month of your birthday?');
                const dayIndex = headers.indexOf('what day of the month is your birthday?');

                if (firstNameIndex === -1 || lastNameIndex === -1 || monthIndex === -1 || dayIndex === -1) {
                    return [];
                }
                
                const result = [];
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    const firstName = (row[firstNameIndex] ?? '').toString().trim();
                    const lastName = (row[lastNameIndex] ?? '').toString().trim();
                    const month = (row[monthIndex] ?? '').toString().trim().padStart(2, '0');
                    const day = (row[dayIndex] ?? '').toString().trim().padStart(2, '0');
                    
                    if (month && day) {
                        const name = `${firstName} ${lastName}`;
                        const birthday = `${month}/${day}`;
                        result.push({ name, birthday });
                    }
                }
                return result;
            }

            // Function to load and display data
            async function loadAndDisplay(file, data) {
                let parsedData = [];
                const fileType = file.name.split('.').pop().toLowerCase();
                
                if (fileType === 'csv') {
                    parsedData = parseCSV(data);
                } else if (fileType === 'xlsx') {
                    parsedData = parseXLSX(data);
                } else {
                    showMessage("Unsupported file type. Please upload a .csv or .xlsx file.");
                    return;
                }

                if (parsedData.length === 0) {
                     showMessage("The uploaded file is not in the expected format. Please check the header names.");
                } else {
                     allBirthdays = parsedData;
                     
                     // Save to localStorage
                     localStorage.setItem('birthdayData', JSON.stringify(allBirthdays));

                     upcomingBirthdaysContainer.classList.remove('hidden');

                     updateDashboard();
                     uploadSectionEl.classList.add('hidden');
                     retrieveUploadButton.classList.remove('hidden');
                }
            }

            // Function to check for today's birthdays and upcoming birthdays
            function updateDashboard() {
                // Today's birthdays
                const now = new Date();
                // For testing, uncomment the line below to simulate a specific date
                // const now = new Date('2025-09-14T12:00:00');
                
                const todayMonth = (now.getMonth() + 1).toString().padStart(2, '0');
                const todayDay = now.getDate().toString().padStart(2, '0');
                const todayDate = `${todayMonth}/${todayDay}`;

                todayDateEl.textContent = `${todayMonth}/${todayDay}`;

                const todayBirthdays = allBirthdays.filter(student => {
                    const [month, day] = student.birthday.split('/').map(part => part.padStart(2, '0'));
                    return `${month}/${day}` === todayDate;
                });

                if (todayBirthdays.length > 0) {
                    const names = todayBirthdays.map(student => student.name).join(' and ');
                    const isPlural = todayBirthdays.length > 1;
                    const message = `ðŸŽ‰ Happy Birthday${isPlural ? 's' : ''}, ${names}! ðŸŽ‰`;
                    
                    birthdayMessageEl.textContent = message;
                    dashboardMessageEl.textContent = "It's a special day!";
                    
                    setTimeout(() => {
                        birthdayMessageEl.classList.remove('scale-0');
                        birthdayMessageEl.classList.add('scale-100');
                    }, 100);

                    for(let i = 0; i < 50; i++) {
                        setTimeout(() => createConfetti(birthdayMessageEl), Math.random() * 2000);
                    }
                } else {
                    birthdayMessageEl.classList.remove('scale-100');
                    birthdayMessageEl.classList.add('scale-0');
                    birthdayMessageEl.textContent = '';
                    dashboardMessageEl.textContent = "No birthdays today.";
                }

                // Upcoming birthdays
                const upcomingBirthdays = getUpcomingBirthdays(allBirthdays, now, 7);
                displayUpcomingBirthdays(upcomingBirthdays);
            }
            
            // Function to sort and get upcoming birthdays
            function getUpcomingBirthdays(students, now, count) {
                const todayMonth = now.getMonth() + 1;
                const todayDay = now.getDate();
                
                const sorted = [...students].sort((a, b) => {
                    const [aMonth, aDay] = a.birthday.split('/').map(Number);
                    const [bMonth, bDay] = b.birthday.split('/').map(Number);

                    let aDiff = (aMonth * 100 + aDay) - (todayMonth * 100 + todayDay);
                    if (aDiff < 0) aDiff += 1231; // Add a large number to put past birthdays at the end

                    let bDiff = (bMonth * 100 + bDay) - (todayMonth * 100 + todayDay);
                    if (bDiff < 0) bDiff += 1231;

                    return aDiff - bDiff;
                });

                // Filter out today's birthdays and duplicates, then take the next 'count'
                const upcoming = sorted.filter(b => {
                    const [month, day] = b.birthday.split('/').map(part => part.padStart(2, '0'));
                    return `${month}/${day}` !== `${(todayMonth).toString().padStart(2,'0')}/${todayDay.toString().padStart(2,'0')}`;
                });
                
                return upcoming.slice(0, count);
            }

            // Function to display upcoming birthdays in the list
            function displayUpcomingBirthdays(birthdays) {
                upcomingListEl.innerHTML = '';
                if (birthdays.length === 0) {
                    upcomingListEl.innerHTML = '<li class="text-sm text-gray-500">No upcoming birthdays.</li>';
                } else {
                    birthdays.forEach(student => {
                        const li = document.createElement('li');
                        li.textContent = `${student.name} - ${student.birthday}`;
                        upcomingListEl.appendChild(li);
                    });
                }
            }

            // Function to create confetti element
            function createConfetti(parentEl) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.top = `-${Math.random() * 20}px`;
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                parentEl.appendChild(confetti);

                setTimeout(() => confetti.classList.add('show'), 100);

                confetti.addEventListener('animationend', () => {
                    confetti.remove();
                });
            }

            // Handle file upload
            dataUploadEl.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    const fileType = file.name.split('.').pop().toLowerCase();
                    if (fileType === 'csv') {
                         reader.onload = (e) => loadAndDisplay(file, e.target.result);
                         reader.readAsText(file);
                    } else if (fileType === 'xlsx') {
                         reader.onload = (e) => loadAndDisplay(file, e.target.result);
                         reader.readAsBinaryString(file);
                    } else {
                         showMessage("Unsupported file type. Please upload a .csv or .xlsx file.");
                    }
                }
            });

            // Handle retrieve upload button click
            retrieveUploadButton.addEventListener('click', () => {
                uploadSectionEl.classList.remove('hidden');
                retrieveUploadButton.classList.add('hidden');
            });
            
            // Handle upcoming birthdays toggle
            toggleUpcomingButton.addEventListener('click', () => {
                const isHidden = upcomingListWrapper.classList.toggle('hidden');
                toggleUpcomingButton.textContent = isHidden ? 'Show Upcoming Birthdays' : 'Hide Upcoming Birthdays';
            });


            // Make sample CSV downloadable
            downloadTemplateEl.addEventListener('click', (event) => {
                const element = document.createElement('a');
                element.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(defaultCSV));
                element.setAttribute('download', 'birthday_template.csv');
                element.style.display = 'none';
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
            });

            // Initial load from localStorage or default CSV
            const savedData = localStorage.getItem('birthdayData');
            if (savedData) {
                allBirthdays = JSON.parse(savedData);
                dashboardMessageEl.textContent = "Birthdays loaded from your browser's storage.";
                upcomingBirthdaysContainer.classList.remove('hidden');
                updateDashboard();
                uploadSectionEl.classList.add('hidden');
                retrieveUploadButton.classList.remove('hidden');
            } else {
                allBirthdays = parseCSV(defaultCSV);
                dashboardMessageEl.textContent = "Using default data. Please upload your file.";
                upcomingBirthdaysContainer.classList.remove('hidden');
                uploadSectionEl.classList.remove('hidden');
                updateDashboard();
            }


            // Refresh logic - check for birthdays every day (e.g., at midnight)
            const now = new Date();
            const midnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0);
            const timeToMidnight = midnight.getTime() - now.getTime();
            setTimeout(() => {
                window.location.reload(); // Reload the page at midnight
            }, timeToMidnight);
        });
    </script>
</body>
</html>
